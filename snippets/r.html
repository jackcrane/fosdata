<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>webR + fosdata Test</title>

    <!-- CodeMirror -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/r/r.min.js"></script>

    <style>
      /* CodeMirror box */
      #cm {
        border: 1px solid #ccc;
        font-size: 12px;
      }
      #cm .CodeMirror {
        height: 260px;
      }
      #cm .CodeMirror-scroll {
        overflow: auto !important;
      }

      button {
        padding: 8px 14px;
        margin-top: 6px;
        font-size: 14px;
        background-color: color-mix(in srgb, #fff 90%, var(--color-link) 10%);
        transition: background-color 0.2s;
        color: var(--color-link);
        border: 1px solid var(--color-link);
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button:not(:disabled):hover {
        background-color: color-mix(in srgb, #fff 90%, var(--color-link) 20%);
      }

      #plot {
        width: 100%;
        max-height: 800px;
        object-fit: contain;
        display: none;
      }

      /* ------------------- Tabs ------------------- */
      .tabs {
        margin-top: 20px;
        display: flex;
        border-bottom: 1px solid #dfdfdf;
      }

      .tab {
        padding: 4px 7px;
        cursor: pointer;
        border: 1px solid #dfdfdf;
        border-bottom: none;
        margin-right: 4px;
        background: hsl(0, 0%, 98%);
        user-select: none;
        font-size: 12px;
      }

      .tab.active {
        background: white;
        border-bottom: 1px solid white;
        font-weight: bold;
      }

      .tab-content {
        display: none;
        padding: 10px;
        background: white;
        border: 1px solid #dfdfdf;
        border-top: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Console box */
      #console {
        background: #f0f0f0;
        color: #000;
        padding: 10px;
        height: 200px;
        overflow: auto;
        font-size: 12px;
        white-space: pre-wrap;
      }
    </style>

    <script>
      /* ---------------------------------------------------------
       * Tab Switching
       * --------------------------------------------------------- */
      const activateTab = (name) => {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));

        document.getElementById("tab-" + name).classList.add("active");
        document.getElementById("content-" + name).classList.add("active");
      };
    </script>

    <script type="module">
      import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";

      /* ---------------------------------------------------------
       * Console logging
       * --------------------------------------------------------- */
      const logConsole = (msg) => {
        try {
          if (JSON.stringify(msg) === "{}") return;
          const out = document.getElementById("console");
          out.textContent += msg.toString() + "\n";
          out.scrollTop = out.scrollHeight;
        } catch (err) {
          console.error(err);
          logConsole(
            "[err] Console logging failed. Your code executed fine. There is more info in the browser console."
          );
        }
      };

      /* ---------------------------------------------------------
       * IndexedDB Cache (1-hour TTL)
       * --------------------------------------------------------- */
      const openDB = () =>
        new Promise((resolve, reject) => {
          const req = indexedDB.open("webr-cache", 1);

          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains("files")) {
              db.createObjectStore("files", { keyPath: "key" });
            }
          };

          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });

      const getCache = async (key) => {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction("files", "readonly");
          const store = tx.objectStore("files");
          const req = store.get(key);

          req.onsuccess = () => {
            const data = req.result;
            if (!data) return resolve(null);

            const isExpired = Date.now() - data.timestamp > 3600_000;
            resolve(isExpired ? null : data.value);
          };

          req.onerror = () => resolve(null);
        });
      };

      const setCache = async (key, value) => {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction("files", "readwrite");
          tx.objectStore("files").put({ key, value, timestamp: Date.now() });
          tx.oncomplete = () => resolve();
        });
      };

      /* ---------------------------------------------------------
       * Fetch override (cache tarballs)
       * --------------------------------------------------------- */
      const realFetch = fetch;

      globalThis.fetch = async (resource, options) => {
        const url = typeof resource === "string" ? resource : resource.url;

        if (url.endsWith(".tar.gz")) {
          const cached = await getCache(url);
          if (cached) {
            return new Response(cached, {
              headers: { "Content-Type": "application/gzip" },
            });
          }

          const res = await realFetch(resource, options);
          const buf = new Uint8Array(await res.clone().arrayBuffer());
          await setCache(url, buf);

          return new Response(buf, {
            headers: { "Content-Type": "application/gzip" },
          });
        }

        return realFetch(resource, options);
      };

      /* ---------------------------------------------------------
       * Global State
       * --------------------------------------------------------- */
      let webR;
      let dataLoaded = false;
      let loadingDone = false;

      const execBtn = () => document.getElementById("execBtn");
      const setBtn = (label, disabled = false) => {
        const b = execBtn();
        b.textContent = label;
        b.disabled = disabled;
      };

      /* ---------------------------------------------------------
       * Cached RDA Loader
       * --------------------------------------------------------- */
      const loadRdaCached = async (url, dest) => {
        let buf = await getCache(url);

        if (!buf) {
          const res = await fetch(url);
          buf = new Uint8Array(await res.arrayBuffer());
          await setCache(url, buf);
        }

        await webR.FS.writeFile(dest, buf);
        await webR.evalR(`load("${dest}")`);
      };

      /* ---------------------------------------------------------
       * Init webR + install packages + load fosdata
       * --------------------------------------------------------- */
      async function init() {
        logConsole("Initializing webR...");
        activateTab("console");
        setBtn("Loading R engine...", true);

        webR = new WebR({ baseUrl: "https://webr.r-wasm.org/latest/" });
        await webR.init();

        const shelter = await new webR.Shelter();
        window._shelter = shelter;

        window.console.warn = (...args) => {
          if (args.toString().includes("Downloading webR")) {
            logConsole(args.toString().trim());
          } else {
            console.warn(...args);
          }
        };

        logConsole("Installing packages...");
        setBtn("Installing packages...", true);

        await webR.installPackages([
          "ggplot2",
          "dplyr",
          "ggthemes",
          "usmap",
          "tidyr",
        ]);

        setBtn("Loading datasets...", true);

        const rdaFiles = [
          "accelerometer.rda",
          "chimps.rda",
          "fish.rda",
          "masks.rda",
          "scrabble.rda",
          "acorns.rda",
          "cigs.rda",
          "flint.rda",
          "mice_pot.rda",
          "seoulweather.rda",
          "adipose.rda",
          "climate.rda",
          "frogs.rda",
          "movies.rda",
          "sharks.rda",
          "austen.rda",
          "conversation.rda",
          "gender.rda",
          "normtemp.rda",
          "skull_geometry.rda",
          "barnacles.rda",
          "covid.rda",
          "hot_dogs.rda",
          "plastics.rda",
          "snails.rda",
          "bechdel.rda",
          "cows_small.rda",
          "houses.rda",
          "powerball.rda",
          "weight_estimate.rda",
          "bicycle_signage.rda",
          "cows.rda",
          "humanization.rda",
          "pres_election.rda",
          "world_cup.rda",
          "biomass.rda",
          "crit_period.rda",
          "leg_strength_full.rda",
          "rio_instagram.rda",
          "wrist.rda",
          "brake.rda",
          "dogs.rda",
          "leg_strength.rda",
          "river_names.rda",
          "cern.rda",
          "draft.rda",
          "letter_frequency.rda",
          "scotland_births.rda",
          "child_tasks.rda",
          "ecars.rda",
          "malaria.rda",
          "scrabble_ml.rda",
        ];

        for (const f of rdaFiles) {
          logConsole(`Loading fosdata: ${f.split(".")[0]}`);
          await loadRdaCached(`/data/${f}`, `/tmp.rda`);
        }

        dataLoaded = true;
        loadingDone = true;
        setBtn("Execute R Code", false);

        await runR(true);
      }

      /* ---------------------------------------------------------
       * Execute R + capture output + auto ggsave
       * --------------------------------------------------------- */
      async function runR(auto = false) {
        if (!dataLoaded) return;
        if (!auto) document.getElementById("console").textContent = "";

        activateTab("console");
        setBtn("Running…", true);

        logConsole("---- Running R ----");

        let code = window.cm.getValue();

        if (
          (code.includes("ggplot(") || code.includes("plot_usmap(")) &&
          !code.includes("ggsave(")
        ) {
          code += `
# Automatically added
ggsave("/plot.png", width = 8, height = 4)
`;
        }

        let result;
        try {
          result = await window._shelter.captureR(code);

          if (Array.isArray(result.output)) {
            for (const evt of result.output) {
              if (evt.type === "stdout" && evt.data) logConsole(evt.data);
              if (evt.type === "stderr" && evt.data)
                logConsole("ERR: " + evt.data);
              if (evt.type === "message" && evt.data) logConsole(evt.data);
              if (
                evt.type === "warning" &&
                evt.data &&
                JSON.stringify(evt.data) !== "{}"
              )
                logConsole("WARNING: " + JSON.stringify(evt.data));
            }
          }
        } catch (err) {
          logConsole("JS Error: " + err);
          console.error(err);
          setBtn("Execute R Code");
          return;
        }

        if (result.stdout) logConsole(result.stdout.trim());
        if (result.stderr) logConsole("ERR: " + result.stderr.trim());

        /* ----- load plot into tab + auto-switch ----- */
        const img = document.getElementById("plot");
        const empty = document.getElementById("plot-empty");

        let plotShown = false;

        try {
          const bytes = await webR.FS.readFile("/plot.png");
          const blob = new Blob([bytes], { type: "image/png" });
          img.src = URL.createObjectURL(blob);

          img.style.display = "block";
          empty.style.display = "none";

          activateTab("plot");
          plotShown = true;
        } catch {
          // No new plot → clear previous plot
          img.src = "";
          img.style.display = "none";
          empty.style.display = "block";

          logConsole("No plot generated.");
        }

        setBtn("Execute R Code");

        logConsole(`---- Done ----\n`);
      }

      window.init = init;
      window.runR = runR;

      init();
    </script>
  </head>

  <body>
    <div id="cm"></div>

    <script>
      const strip = (s) => s.trim();

      window.cm = CodeMirror(document.querySelector("#cm"), {
        lineNumbers: true,
        tabSize: 2,
        mode: "r",
        value: strip(`__R_DEFAULT_CODE__`),
        extraKeys: {
          "Cmd-Enter": () => {
            if (!execBtn().disabled) runR();
          },
          "Ctrl-Enter": () => {
            if (!execBtn().disabled) runR();
          },
        },
      });
    </script>

    <br />
    <button id="execBtn" onclick="runR()">Loading…</button>

    <!-- ------------------- Tabs ------------------- -->
    <div class="tabs">
      <div id="tab-console" class="tab active" onclick="activateTab('console')">
        Console
      </div>
      <div id="tab-plot" class="tab" onclick="activateTab('plot')">Plot</div>
    </div>

    <!-- Console -->
    <div id="content-console" class="tab-content active">
      <pre id="console"></pre>
    </div>

    <!-- Plot -->
    <div id="content-plot" class="tab-content">
      <div
        id="plot-empty"
        style="padding: 20px; text-align: center; color: #777; font-size: 13px"
      >
        No plot generated yet.
      </div>
      <img id="plot" alt="scatterplot" />
    </div>
  </body>
</html>
