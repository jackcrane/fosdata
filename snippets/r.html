<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>webR + fosdata Test</title>
    <script type="module">
      import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";

      let webR;

      async function init() {
        webR = new WebR({
          baseUrl: "https://webr.r-wasm.org/latest/",
        });
        await webR.init();
        await webR.installPackages(["ggplot2", "dplyr", "ggthemes"]);

        console.log("Initted");

        const files = [
          "accelerometer.rda",
          "chimps.rda",
          "fish.rda",
          "masks.rda",
          "scrabble.rda",
          "acorns.rda",
          "cigs.rda",
          "flint.rda",
          "mice_pot.rda",
          "seoulweather.rda",
          "adipose.rda",
          "climate.rda",
          "frogs.rda",
          "movies.rda",
          "sharks.rda",
          "austen.rda",
          "conversation.rda",
          "gender.rda",
          "normtemp.rda",
          "skull_geometry.rda",
          "barnacles.rda",
          "covid.rda",
          "hot_dogs.rda",
          "plastics.rda",
          "snails.rda",
          "bechdel.rda",
          "cows_small.rda",
          "houses.rda",
          "powerball.rda",
          "weight_estimate.rda",
          "bicycle_signage.rda",
          "cows.rda",
          "humanization.rda",
          "pres_election.rda",
          "world_cup.rda",
          "biomass.rda",
          "crit_period.rda",
          "leg_strength_full.rda",
          "rio_instagram.rda",
          "wrist.rda",
          "brake.rda",
          "dogs.rda",
          "leg_strength.rda",
          "river_names.rda",
          "cern.rda",
          "draft.rda",
          "letter_frequency.rda",
          "scotland_births.rda",
          "child_tasks.rda",
          "ecars.rda",
          "malaria.rda",
          "scrabble_ml.rda",
        ];

        const loadRda = async (url, dest = "/tmp.rda") => {
          const res = await fetch(url);
          const buf = new Uint8Array(await res.arrayBuffer());
          await webR.FS.writeFile(dest, buf);
          await webR.evalR(`load("${dest}")`);
        };

        for (const f of files) await loadRda(`/data/${f}`);

        console.log("All RDA loaded");
      }

      async function runR() {
        const code = document.getElementById("rcode").value;

        // ALWAYS write the output to /plot.png
        const wrapped = `
          ${code}
        `;

        console.log("Running R...");
        await webR.evalR(wrapped);

        const pngBytes = await webR.FS.readFile("/plot.png");
        const blob = new Blob([pngBytes], { type: "image/png" });
        const url = URL.createObjectURL(blob);
        document.getElementById("plot").src = url;
      }

      window.init = init;
      window.runR = runR;

      init();
    </script>

    <style>
      textarea {
        width: 100%;
        height: 220px;
        font-family: monospace;
        font-size: 14px;
      }
      button {
        padding: 8px 14px;
        margin-top: 6px;
      }
    </style>
  </head>

  <body>
    <h1>webR + fosdata test</h1>

    <textarea id="rcode">
library(ggplot2)

p <- ggplot(rio_instagram, aes(x = n_post, y = n_follower)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Number of Posts",
    y = "Number of Followers",
    title = "Followers vs Posts"
  )

ggsave("/plot.png", p, width = 6, height = 4, dpi = 150)
    </textarea>

    <br />
    <button onclick="runR()">Execute R Code</button>

    <h2>Output Plot</h2>
    <img id="plot" alt="scatterplot" />
  </body>
</html>
