<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/r/r.min.js"></script>

    <meta charset="utf-8" />
    <title>webR + fosdata Test</title>

    <style>
      #cm {
        border: 1px solid #ccc;
        height: 260px;
        overflow: auto;
        font-size: 12px;
      }
      button {
        padding: 8px 14px;
        margin-top: 6px;
        font-size: 14px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      #plot {
        width: 100%;
        max-height: 800px;
        object-fit: contain;
      }
      #plot:invalid {
        display: none;
      }
    </style>

    <script type="module">
      import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";

      let webR;
      let dataLoaded = false;

      const execBtn = () => document.getElementById("execBtn");

      const setBtn = (label, disabled = false) => {
        const b = execBtn();
        b.textContent = label;
        b.disabled = disabled;
      };

      async function init() {
        setBtn("Loading R engine...", true);

        webR = new WebR({
          baseUrl: "https://webr.r-wasm.org/latest/",
        });

        await webR.init();

        setBtn("Installing packages...", true);
        await webR.installPackages(["ggplot2", "dplyr", "ggthemes"]);

        setBtn("Loading datasets...", true);

        const files = [
          "accelerometer.rda",
          "chimps.rda",
          "fish.rda",
          "masks.rda",
          "scrabble.rda",
          "acorns.rda",
          "cigs.rda",
          "flint.rda",
          "mice_pot.rda",
          "seoulweather.rda",
          "adipose.rda",
          "climate.rda",
          "frogs.rda",
          "movies.rda",
          "sharks.rda",
          "austen.rda",
          "conversation.rda",
          "gender.rda",
          "normtemp.rda",
          "skull_geometry.rda",
          "barnacles.rda",
          "covid.rda",
          "hot_dogs.rda",
          "plastics.rda",
          "snails.rda",
          "bechdel.rda",
          "cows_small.rda",
          "houses.rda",
          "powerball.rda",
          "weight_estimate.rda",
          "bicycle_signage.rda",
          "cows.rda",
          "humanization.rda",
          "pres_election.rda",
          "world_cup.rda",
          "biomass.rda",
          "crit_period.rda",
          "leg_strength_full.rda",
          "rio_instagram.rda",
          "wrist.rda",
          "brake.rda",
          "dogs.rda",
          "leg_strength.rda",
          "river_names.rda",
          "cern.rda",
          "draft.rda",
          "letter_frequency.rda",
          "scotland_births.rda",
          "child_tasks.rda",
          "ecars.rda",
          "malaria.rda",
          "scrabble_ml.rda",
        ];

        const loadRda = async (url, dest = "/tmp.rda") => {
          const res = await fetch(url);
          const buf = new Uint8Array(await res.arrayBuffer());
          await webR.FS.writeFile(dest, buf);
          await webR.evalR(`load("${dest}")`);
        };

        setBtn(`Loading Fosdata datasets...`, true);
        for (const f of files) {
          await loadRda(`/data/${f}`);
        }

        dataLoaded = true;
        setBtn("Execute R Code", false);

        console.log("All RDA loaded");
        await runR();
      }

      async function runR() {
        if (!dataLoaded) return;

        setBtn("Running…", true);

        const code = window.cm.getValue();
        await webR.evalR(code);

        const pngBytes = await webR.FS.readFile("/plot.png");
        const blob = new Blob([pngBytes], { type: "image/png" });
        const url = URL.createObjectURL(blob);
        document.getElementById("plot").src = url;

        setBtn("Execute R Code", false);
      }

      window.init = init;
      window.runR = runR;

      init();
    </script>
  </head>

  <body>
    <div id="cm"></div>

    <script>
      window.cm = CodeMirror(document.querySelector("#cm"), {
        lineNumbers: true,
        tabSize: 2,
        mode: "r",
        value: `library(ggplot2)

p <- ggplot(rio_instagram, aes(x = n_post, y = n_follower, color = country)) +
  geom_point(alpha = 0.6) +
  scale_y_log10() +
  labs(
    x = "Number of Posts",
    y = "Number of Followers (log scale)",
    title = "Followers vs Posts by Sport"
  )

ggsave("/plot.png", width = 8, height = 4)`,
      });
    </script>

    <br />
    <button id="execBtn" onclick="runR()">Loading…</button>

    <h2>Output Plot</h2>
    <img id="plot" alt="scatterplot" />
  </body>
</html>
